# Cross-Robot Movement Imitation: Record and Playback Workflow

This document outlines the "record and playback" workflow for the Franka-to-xArm robot movement imitation task. This approach decouples the leader (Franka) and follower (xArm) robots, using separate, non-concurrent simulation stages.

## Objective
The primary goal is to enable an xArm 7-DOF robot to mimic a pre-defined movement from a Franka Emika Panda robot. This is achieved by recording the Franka's end-effector trajectory and then replaying it on the xArm using a Forward Kinematics (FK) to Inverse Kinematics (IK) pipeline.

## New Workflow: Record and Playback

This workflow is divided into two distinct phases:

### Phase 1: Trajectory Recording (Franka)
In this phase, we only need the Franka robot simulation.
1.  **Launch Franka Environment:** A launch file starts the Franka Gazebo simulation and its MoveIt! planning environment.
2.  **Plan and Record:** A dedicated Python script (`record_franka_poses.py`) plans a motion for the Franka's end-effector to a target pose.
3.  **Forward Kinematics (FK):** For each point in the planned joint trajectory, the script uses FK to calculate the corresponding 3D pose (position and orientation) of the end-effector.
4.  **Save Path:** The resulting sequence of end-effector poses is serialized and saved to a file (e.g., `franka_poses.json`).

### Phase 2: Trajectory Playback (xArm)
In this phase, we only need the xArm robot simulation.
1.  **Launch xArm Environment:** A separate launch file starts the xArm Gazebo simulation and its MoveIt! planning environment.
2.  **Load Path:** A playback script (`playback_xarm_from_poses.py`) loads the `franka_poses.json` file.
3.  **Inverse Kinematics (IK):** The script uses MoveIt's `compute_cartesian_path` function. This function takes the loaded sequence of poses as waypoints and performs the necessary IK calculations to generate a valid joint trajectory for the xArm.
4.  **Execute Trajectory:** The script commands the xArm's controllers to execute the generated trajectory, causing it to mimic the Franka's original movement.

## Gazebo Simulation Setup
Details the specific Gazebo environments for each phase.

### Phase 1: Franka (Leader) Environment
- **Launch File:** `franka_gazebo/launch/panda.launch`
- **Purpose:** Spawns the Franka Panda robot and the required objects (bowl, marker) into a Gazebo world.
- **Robot Base Position:** `x=-0.2, y=-0.8, z=1.021`
- **Command:** `roslaunch franka_gazebo panda.launch`

### Phase 2: xArm (Follower) Environment
- **Launch File:** `xarm_gazebo/launch/xarm7_new.launch`
- **Purpose:** Spawns the xArm7 robot and the same objects into a Gazebo world for the playback phase.
- **Robot Base Position:** `x=-0.2, y=-0.6, z=1.021`, `yaw=1.571`
- **Command:** `roslaunch xarm_gazebo xarm7_new.launch`

## Running the Full Pipeline

**Part 1: Record Franka Trajectory**

1.  **Terminal 1: Launch Franka Simulation**
    ```bash
    roslaunch franka_gazebo panda.launch controller:=position_joint_trajectory_controller
    ```
2.  **Terminal 2: Run the Recording Script**
    ```bash
    roslaunch franka_recording record_moveit.launch
    ```
    Wait for the script to finish. It will save `franka_poses.json`. Once done, you can close the Franka simulation (Ctrl+C in Terminal 1).

**Part 2: Playback on xArm**

1.  **Terminal 1: Launch xArm Simulation**
    ```bash
    roslaunch xarm_gazebo xarm7_new.launch
    ```
2.  **Terminal 2: Run the Playback Script**
    ```bash
    roslaunch xarm_following playback_ik.launch
    ```
    The xArm will now execute the trajectory.

## Current Problem and Strategy

### Solved Problems
-   **URDF Configuration (Franka):** The mismatch between the loaded URDF and SRDF for the Franka robot was resolved. We now use `panda_moveit.urdf.xacro` (which includes `franka_robot_no_camera.xacro`) to ensure MoveIt loads the robot model without camera-related conflicts and with the gripper enabled. This involved modifying `panda_moveit_config/launch/planning_context.launch` to correctly reference these custom xacro files and pass `hand:=true`.
-   **`record_franka_poses.py` Script Debugging (Phase 1 Completion):**
    -   **Syntax Errors (f-strings):** Resolved `SyntaxError` by replacing f-strings with `.format()` calls in `record_franka_poses.py` to ensure compatibility with the ROS Python environment.
    -   **`ImportError: No module named yaml`:** Addressed by ensuring `pyyaml` was correctly installed and accessible to the ROS Python 3 interpreter.
    -   **`AttributeError: 'dict' object has no attribute 'x'`:** Fixed by correctly instantiating `geometry_msgs.msg.Point` and `geometry_msgs.msg.Quaternion` objects when defining `Pose` messages in `record_franka_poses.py`.
    -   **"Action client not connected" / "Unable to identify any set of controllers":** Resolved by configuring `panda_moveit_config/config/simple_moveit_controllers.yaml` to explicitly use `position_joint_trajectory_controller` as the default for the `panda_arm` group, aligning MoveIt's expectations with the working controller.
    -   **Phase 1 Success:** The `record_franka_poses.py` script now successfully plans trajectories, computes forward kinematics, and saves the Franka's end-effector poses to `franka_poses.json`.

-   **xArm MoveIt! Configuration & Controller Issues (Phase 2 Debugging):**
    -   **"Robot semantic description not found" / "Group 'xarm_gripper' was not found" / "Group 'xarm7' was not found":**
        -   The `planning_context.launch` in `xarm7_moveit_config` was initially commented out in `move_group.launch`, preventing the SRDF from being loaded. This was re-enabled.
        -   The `add_gripper` argument was not being propagated from `playback_moveit.launch` to `xarm7_moveit_config/launch/move_group.launch` and then to `planning_context.launch`. This was fixed by explicitly passing `add_gripper="true"` in `playback_moveit.launch` and ensuring `move_group.launch` passes it to `planning_context.launch`.
        -   Switched from `xarm7_moveit_config` to `xarm7_gripper_moveit_config` in `playback_moveit.launch` as it's specifically designed for the xArm with a gripper.
        -   Ensured `xarm7_gripper_moveit_config/launch/move_group.launch` passes `load_robot_description="true"` to its `planning_context.launch`.
    -   **"Unable to connect to move_group action server 'move_group' within allotted time (5s)":**
        -   Increased `controller_manager_startup_timeout` in `xarm7_gripper_moveit_config/launch/move_group.launch` to 30 seconds to give the `move_group` node more time to initialize its internal components and action servers.
        -   Increased `moveit_commander_connection_timeout` for the `xarm_player` node in `playback_moveit.launch` to 20 seconds to give the Python script more time to connect to the `move_group` action server.
    -   **Incorrect Controller Naming/Namespace:**
        -   The `controllers.yaml` and `controllers_with_gripper.yaml` in `xarm7_gripper_moveit_config/config` had incorrect or empty controller names. These were updated to include the `/xarm` namespace and the correct controller names (e.g., `/xarm/xarm7_traj_controller`, `/xarm/gripper_traj_controller`).
        -   The `action_ns` and `type` for the gripper controller in `controllers_with_gripper.yaml` were corrected to `follow_joint_trajectory` and `FollowJointTrajectory` respectively, to match the actual controller type.
    -   **"arg 'gripper_controller' is not defined":**
        -   The `gripper_controller` argument was not being passed to `xarm7_gripper_moveit_config/launch/move_group.launch`. This was fixed by adding `gripper_controller="true"` to the include statement in `playback_moveit.launch`.
    -   **"Kinematics solver doesn't support #attempts anymore":**
        -   Removed `kinematics_solver_attempts` from `xarm7_gripper_moveit_config/config/kinematics.yaml`.

### Problem Description
Phase 2 (Trajectory Playback for xArm) is now ready for re-evaluation. The focus is on verifying the `playback_xarm_from_poses.py` script's functionality, including loading the recorded Franka poses, performing IK for the xArm, and executing the trajectory.

### Current Strategy
The current strategy involves:
1.  Thoroughly testing `playback_xarm_from_poses.py` by launching the xArm Gazebo environment and the playback script.
2.  Monitoring for any runtime errors or unexpected behavior during trajectory loading, IK calculation, or execution.
3.  Verifying that the xArm accurately mimics the Franka's recorded movement.


## Key Files for this Workflow
-   **Gazebo Launch (Franka):** `franka_gazebo/launch/panda.launch`
-   **Gazebo Launch (xArm):** `xarm_gazebo/launch/xarm7_new.launch`
-   **Recording Script:** `Cross_Movement/Franka_Recording/src/record_franka_poses.py`
-   **Recording Launch File:** `Cross_Movement/Franka_Recording/launch/record_moveit.launch`
-   **Playback Script:** `Cross_Movement/xarm_Following/src/playback_xarm_from_poses.py`
-   **Playback Launch File:** `Cross_Movement/xarm_Following/launch/playback_moveit.launch`
-   **Trajectory Data:** `franka_poses.json` (generated in the `Franka_Recording` package)

This decoupled approach simplifies the simulation process and removes the need for real-time communication between two concurrent Gazebo instances.